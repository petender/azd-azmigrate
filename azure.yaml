# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: azd-azmigrate
metadata:
  template: azd-azmigrate@0.0.1-beta

# Infrastructure deployment configuration
infra:
  provider: bicep
  path: infra/bicep
  module: main

# Hooks for deployment lifecycle
hooks:
  postprovision:
    windows:
      shell: pwsh
      run: |
        Write-Host "======================================"
        Write-Host "Azure Migrate Demo Environment Deployed!"
        Write-Host "======================================"
        Write-Host ""
        
        # Get deployment outputs
        $envName = azd env get-value AZURE_ENV_NAME
        $deploymentName = az deployment sub list --query "[?contains(name, 'mig1026am')].name | [0]" -o tsv
        
        if ($deploymentName) {
          $outputs = az deployment sub show --name $deploymentName --query "properties.outputs" -o json | ConvertFrom-Json
          
          Write-Host "Connection Information:"
          Write-Host "  Hyper-V Host Public IP: $($outputs.hypervHostPublicIp.value)"
          Write-Host "  Hyper-V Host FQDN: $($outputs.hypervHostFqdn.value)"
          Write-Host "  Azure Bastion: $($outputs.bastionHostName.value)"
          Write-Host ""
          Write-Host "Azure Migrate Resources:"
          Write-Host "  Project Name: $($outputs.migrateProjectName.value)"
          Write-Host "  Key Vault: $($outputs.keyVaultName.value)"
          Write-Host "  Recovery Vault: $($outputs.recoveryServicesVaultName.value)"
          Write-Host ""
          
          # Run interactive menu script
          $menuScript = Join-Path $PSScriptRoot "scripts\Setup-AzureMigrateMenu.ps1"
          if (Test-Path $menuScript) {
            & $menuScript -EnvironmentName $envName
          }
            $username = azd env get-value ADMIN_USERNAME
          
          # Run interactive menu script
          $menuScript = Join-Path $PSScriptRoot "scripts\Setup-AzureMigrateMenu.ps1"
          if (Test-Path $menuScript) {
            & $menuScript -EnvironmentName $envName
          }
        } else {
          Write-Host "  Unable to retrieve deployment outputs"
        }
        
        Write-Host ""
    posix:
      shell: sh
      run: |
        echo "======================================"
        echo "Azure Migrate Demo Environment Deployed!"
        echo "======================================"
        echo ""
        echo "Connection Information:"
        echo "  Hyper-V Host Public IP: $(azd env get-value HYPERVHOSTPUBLICIP)"
        echo "  Hyper-V Host FQDN: $(azd env get-value HYPERVHOSTFQDN)"
        echo "  Azure Bastion: $(azd env get-value BASTIONHOSTNAME)"
        echo ""
        echo "Next Steps:"
        echo "  1. Connect to Hyper-V host via Azure Bastion"
        echo "  2. Download Azure Migrate appliance VHD"
        echo "  3. Configure discovery in Azure Migrate"
        echo ""
